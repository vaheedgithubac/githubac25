## How to download ECR Private Repo image in Kubernetes
‚úÖ This is the **BEST and recommended approach** for EKS + ECR.  
1Ô∏è‚É£ What IRSA solves (big picture)

**Problem without IRSA:**
  - You create ECR secrets
  - Tokens expire every 12 hours
  - You must rotate them        

**IRSA solution:**
  - No Docker secrets
  - No tokens
  - No rotation
  - Pods automatically authenticate to ECR using AWS IAM
`Kubernetes ‚Üí AWS IAM ‚Üí ECR (secure & automatic)`

## 2Ô∏è‚É£ How IRSA works (mental model)  
```text
Pod
 ‚îî‚îÄ ServiceAccount
     ‚îî‚îÄ IAM Role (via OIDC)
         ‚îî‚îÄ ECR permissions
```
- Pod uses a Kubernetes ServiceAccount
- ServiceAccount is linked to an IAM Role
- AWS allows that role to pull images from ECR

## 3Ô∏è‚É£ Prerequisites
**You must have:**  
‚úî EKS cluster  
‚úî AWS CLI configured  
‚úî `eksctl` installed  
‚úî ECR repository exists  

## 4Ô∏è‚É£ Enable OIDC provider (one-time)
Create IAM OIDC privider
```bash
eksctl utils associate-iam-oidc-provider \
  --cluster my-cluster \
  --region us-east-1 \
  --approve
```
‚úî This allows EKS to use IAM roles with ServiceAccounts

### 5Ô∏è‚É£ Create IAM policy for ECR access  
Create a file `ecr-policy.json`:
```text
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchGetImage",
        "ecr:GetDownloadUrlForLayer"
      ],
      "Resource": "*"
    }
  ]
}
```
Create the policy:
```bash
aws iam create-policy \
  --policy-name EKS-ECR-Pull-Policy \
  --policy-document file://ecr-policy.json
```
### 6Ô∏è‚É£ Create IAM Role + ServiceAccount (IRSA) 
This command does everything:
  - Creates IAM Role
  - Attaches ECR policy
  - Creates Kubernetes ServiceAccount
  - Links them together

```bash
eksctl create iamserviceaccount \
  --cluster my-cluster \
  --region us-east-1 \
  --namespace app \
  --name ecr-sa \
  --attach-policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/EKS-ECR-Pull-Policy \
  --approve
```
‚úÖ Result:
  - IAM Role created
  - ServiceAccount `ecr-sa` created in `app` namespace  

### 7Ô∏è‚É£ Use the ServiceAccount in your Deployment  
`Deployment.yaml`
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
  namespace: app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      serviceAccountName: ecr-sa
      containers:
      - name: app
        image: 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-app:latest
```
üö® Important:  
  ‚ùå NO imagePullSecrets  
  ‚ùå NO Docker secret  
  ‚úî IRSA handles auth  

## 8Ô∏è‚É£ What happens at runtime (flow)  
**1. Pod starts**  
**2. Kubelet requests image from ECR**  
**3. AWS checks IAM role via OIDC**  
**4. Role has ECR permissions**  
**5. Image is pulled**  
**6. Pod runs**  

## 9Ô∏è‚É£ How to verify IRSA is working 
**Check ServiceAccount annotation**
```bash
kubectl get sa ecr-sa -n app -o yaml
```  
You should see:   
```yaml
eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/eksctl-...
```
**Check pod events**
```bash
kubectl describe pod <pod-name> -n app
```
If working:
  - ‚ùå No ImagePullBackOff
  - ‚ùå No auth errors

## üîü Common mistakes (VERY common)

‚ùå Forgetting to use the ServiceAccount in Deployment  
‚ùå Wrong namespace  
‚ùå Missing OIDC provider  
‚ùå Using node IAM role instead (old method)  
‚ùå ECR repo in different region  

## 1Ô∏è‚É£1Ô∏è‚É£ Comparison (why IRSA wins)
| Method        | Secrets | Rotation | Security | Recommended |
| ------------- | ------- | -------- | -------- | ----------- |
| Docker secret | Yes     | Manual   | ‚ö†Ô∏è       | ‚ùå           |
| Cron refresh  | Yes     | Auto     | ‚ö†Ô∏è       | ‚ö†Ô∏è          |
| Node IAM role | No      | Auto     | ‚ö†Ô∏è       | ‚ùå           |
| **IRSA**      | **No**  | **Auto** | **‚úÖ**    | **‚≠ê‚≠ê‚≠ê**     |  

üß† Final takeaway  
**If you are using EKS + ECR ‚Üí always use IRSA**  
**It is:**
 - Secure
 - Simple
 - Production-grade
 - GitOps-friendly
 - Zero secrets










