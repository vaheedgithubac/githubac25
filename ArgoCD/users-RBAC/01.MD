## ğŸ”¹Namespace wise access seperation: ApplicationSet + RBAC + Local users `(argocd-cm)`ğŸ”¹
## Can different users get access to different namespaces?  
## Git Repo Structure
```text
expense/
â””â”€â”€ cd/
    â””â”€â”€ argocd/
        â””â”€â”€ dev/
            â”œâ”€â”€ frontend/
            â”‚   â””â”€â”€ helm/
            â”‚       â”œâ”€â”€ Chart.yml
            â”‚       â”œâ”€â”€ values.yml
            â”‚       â””â”€â”€ templates/
            â”‚           â”œâ”€â”€ deployment.yml
            â”‚           â””â”€â”€ service.yml
            â”œâ”€â”€ backend/
            â”‚   â””â”€â”€ helm/
            â”‚       â”œâ”€â”€ Chart.yaml
            â”‚       â”œâ”€â”€ values.yml
            â”‚       â””â”€â”€ templates/
            â”‚           â”œâ”€â”€ deployment.yml
            â”‚           â””â”€â”€ service.yml
            â””â”€â”€ database/
                â””â”€â”€ helm/
                    â”œâ”€â”€ Chart.yaml
                    â”œâ”€â”€ values.yml
                    â””â”€â”€ templates/
                        â”œâ”€â”€ deployment.yml
                        â”œâ”€â”€ service.yml
                        â””â”€â”€ pvc.yml
```
**âš ï¸ IMPORTANT LIMITATION**  
**RBAC in Argo CD is NOT namespace-aware**  
RBAC works on:  
```text
Project / Application
```
âŒ You **CANNOT** directly say:   
"User A â†’ expense-dev namespace only"  
âœ” You **MUST use projects (or app names)** to separate access.  

## âœ… CORRECT & RECOMMENDED DESIGN
**âœ” Separate projects per environment**  
| Environment | AppProject      |
| ----------- | --------------- |
| Dev         | `expense-dev`   |
| Stage       | `expense-stage` |
| Prod        | `expense-prod`  |

## ğŸ§© Architecture Overview  
```text
argocd-cm        â†’ defines users (authentication)    
argocd-rbac-cm   â†’ defines permissions (authorization)    
AppProject       â†’ limits what resources/apps can exist     
ApplicationSet   â†’ auto-creates Applications    
Application      â†’ created dynamically by ApplicationSet    
```
## ğŸ”¹ â€“ Prerequisites (DO NOT SKIP)
**Verify ApplicationSet controller exists**
```bash
kubectl get deploy -n argocd argocd-applicationset-controller
```
If not present, install ApplicationSet controller
## ğŸ”¹ â€“ Define Users (argocd-cm) ğŸ”
This creates local Argo CD users.
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  application.namespaces: argocd        # Ensure **Application** CRDs should be created in `argocd` namespace

  accounts.expense-dev-user: login
  accounts.expense-prod-user: login
  accounts.expense-admin-user: login
```
Apply: 
```bash
kubectl apply -f argocd-cm.yaml
```
Set passwords 
```bash
argocd account update-password --account expense-dev-user
argocd account update-password --account expense-prod-user
argocd account update-password --account expense-admin-user
```
## ğŸ”¹ AppProjects per environment ğŸ§±
**Dev Project**
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-dev                                    # 'Dev' environment
  namespace: argocd
spec:
  sourceRepos:
    - https://github.com/my-org/expense.git

  destinations:
    - server: https://kubernetes.default.svc           # Same cluster where ArgoCD is running
      namespace: expense-dev                           # 'dev' namespace

  clusterResourceWhitelist:
    - group: ""
      kind: "Namespace"                                # This Project will allow child Apps to create Namespace

  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"
```
**Stage Project**  
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-stage              # 'Stage' environment
  namespace: argocd
spec:
  sourceRepos:
    - https://github.com/my-org/expense.git

  destinations:
    - server: https://kubernetes.default.svc
      namespace: expense-stage

  clusterResourceWhitelist:
    - group: ""
      kind: "Namespace"             # This Project will allow child Apps to create Namespace

  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"
```
**Prod Project (locked down ğŸ”’)**
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-prod                # 'Prod' environment
  namespace: argocd
spec:
  sourceRepos:
    - https://github.com/my-org/expense.git

  destinations:
    - server: https://kubernetes.default.svc
      namespace: expense-prod

  clusterResourceWhitelist:
    - group: ""
      kind: "Namespace"             # This Project will allow child Apps to create Namespace

  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"

```
## ğŸ”¹ RBAC per user per environment ğŸ”
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly

  policy.csv: |
    # expense Dev + Stage user
    p, role:expense-nonprod, applications, *, expense-dev/*, allow
    p, role:expense-nonprod, applications, *, expense-stage/*, allow

    # expense Prod user
    p, role:expense-prod, applications, *, expense-prod/*, allow

    # expense Admin (FULL)
    p, role:expense-admin, *, *, expense-dev/*, allow
    p, role:expense-admin, *, *, expense-stage/*, allow
    p, role:expense-admin, *, *, expense-prod/*, allow


                    # p, role:expense-nonprod, applications, get, expense-dev/*, allow
                    # p, role:expense-nonprod, applications, list, expense-dev/*, allow
                    # p, role:expense-nonprod, applications, sync, expense-dev/*, allow
                
                    # p, role:expense-nonprod, applications, get, expense-stage/*, allow
                    # p, role:expense-nonprod, applications, list, expense-stage/*, allow
                    # p, role:expense-nonprod, applications, sync, expense-stage/*, allow
                
                    # Prod user (read-only or tightly controlled)
                      # p, role:expense-prod, applications, get, expense-prod/*, allow
                      # p, role:expense-prod, applications, list, expense-prod/*, allow

    # Bind users
    g, expense-dev-user, role:expense-nonprod
    g, expense-prod-user, role:expense-prod
    g, expense-admin-user, role:expense-admin
```
Explanation:
```text
syntax:  p, <subject>, <resource>, <action>, <object>, <effect>
example: p, role:expense-nonprod, applications, *, expense-dev/*, allow   
```
| Field                  | Value    | Meaning                                    |
| ---------------------- | -------- | ------------------------------------------ |
| `p`                    | policy   | This is a permission rule                  |
| `role:expense-nonprod` | subject  | The RBAC role                              |
| `applications`         | resource | Argo CD Application objects                |
| `*`                    | action   | Any action (get, list, sync, delete, etc.) |
| `expense-dev/*`        | object   | **project/application-name**               |
| `allow`                | effect   | Permit access                              |

```text
syntax:   g, <subject>, <role>
example:  g, expense-dev-user, role:expense-nonprod
```
| Part                   | Value         | Meaning            |
| ---------------------- | ------------- | ------------------ |
| `g`                    | grouping rule | Assign membership  |
| `expense-dev-user`     | subject       | A **user account** |
| `role:expense-nonprod` | role          | The RBAC role      |


## ApplicationSet per environment (best practice)
```yaml
---
spec:
  template:
    spec:
      project: expense-dev        # 'dev' environment
---
spec:
  template:
    spec:
      project: expense-stage      # 'stage' environment
---
spec:
  template:
    spec:
      project: expense-prod       # 'prod' environment
```
## Full example (Dev) - ApplicationSet
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: expense-applicationset-dev
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          - list:
              elements:
                - env: dev
                #- env: stage
                #- env: prod
          - git:
              repoURL: https://github.com/my-org/my-repo.git
              revision: main
              directories:
                - path: cd/argocd/{{env}}/*
  template:
    metadata:
      name: expense-{{env}}-{{path.basename}}
      namespace: argocd
      labels:
        env: "{{env}}"
        project: expense
        component: "{{path.basename}}"

      annotations:
        # ğŸ”¹ SYNC WAVES (CRITICAL)
        argocd.argoproj.io/sync-wave: >
          {{- if eq path.basename "database" -}}0
          {{- else if eq path.basename "backend" -}}1
          {{- else if eq path.basename "frontend" -}}2
          {{- end }}

        # ğŸ”¹ Notifications
        notifications.argoproj.io/subscribe.on-deployed.email: "expense-{{env}}-{{path.basename}}@example.com"
        notifications.argoproj.io/subscribe.on-health-degraded.email: "expense-{{env}}-{{path.basename}}@example.com"
        notifications.argoproj.io/subscribe.on-sync-failed.email: "expense-{{env}}-{{path.basename}}@example.com"

    spec:
      project: expense-dev         # This is the name of 'AppProject' created previously

      source:
        repoURL: https://github.com/my-org/my-repo.git
        targetRevision: main
        path: "{{path}}/helm"
        helm:
          valueFiles:
            - values.yml

      destination:
        server: https://kubernetes.default.svc
        namespace: "expense-{{env}}"

      syncPolicy:
        automated:
          prune: true          # delete resources not in Git
          selfHeal: true       # revert out-of-band changes
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
          - ServerSideApply=true
          - PruneLast=true
```
## Full example (Stage) - ApplicationSet
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: expense-applicationset-stage
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          - list:
              elements:
                #- env: dev
                - env: stage
                #- env: prod
          - git:
              repoURL: https://github.com/my-org/my-repo.git
              revision: main
              directories:
                - path: cd/argocd/{{env}}/*
  template:
    metadata:
      name: expense-{{env}}-{{path.basename}}
      namespace: argocd
      labels:
        env: "{{env}}"
        project: expense
        component: "{{path.basename}}"

      annotations:
        # ğŸ”¹ SYNC WAVES (CRITICAL)
        argocd.argoproj.io/sync-wave: >
          {{- if eq path.basename "database" -}}0
          {{- else if eq path.basename "backend" -}}1
          {{- else if eq path.basename "frontend" -}}2
          {{- end }}

        # ğŸ”¹ Notifications
        notifications.argoproj.io/subscribe.on-deployed.email: "expense-{{env}}-{{path.basename}}@example.com"
        notifications.argoproj.io/subscribe.on-health-degraded.email: "expense-{{env}}-{{path.basename}}@example.com"
        notifications.argoproj.io/subscribe.on-sync-failed.email: "expense-{{env}}-{{path.basename}}@example.com"

    spec:
      project: expense-stage         # This is the name of 'AppProject' created previously

      source:
        repoURL: https://github.com/my-org/my-repo.git
        targetRevision: main
        path: "{{path}}/helm"
        helm:
          valueFiles:
            - values.yml

      destination:
        server: https://kubernetes.default.svc
        namespace: "expense-{{env}}"

      syncPolicy:
        automated:
          prune: true          # delete resources not in Git
          selfHeal: true       # revert out-of-band changes
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
          - ServerSideApply=true
          - PruneLast=true
```
## Full example (Prod) - ApplicationSet
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: expense-applicationset-prod
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          - list:
              elements:
                #- env: dev
                #- env: stage
                - env: prod
          - git:
              repoURL: https://github.com/my-org/my-repo.git
              revision: main
              directories:
                - path: cd/argocd/{{env}}/*
  template:
    metadata:
      name: expense-{{env}}-{{path.basename}}
      namespace: argocd
      labels:
        env: "{{env}}"
        project: expense
        component: "{{path.basename}}"

      annotations:
        # ğŸ”¹ SYNC WAVES (CRITICAL)
        argocd.argoproj.io/sync-wave: >
          {{- if eq path.basename "database" -}}0
          {{- else if eq path.basename "backend" -}}1
          {{- else if eq path.basename "frontend" -}}2
          {{- end }}

        # ğŸ”¹ Notifications
        notifications.argoproj.io/subscribe.on-deployed.email: "expense-{{env}}-{{path.basename}}@example.com"
        notifications.argoproj.io/subscribe.on-health-degraded.email: "expense-{{env}}-{{path.basename}}@example.com"
        notifications.argoproj.io/subscribe.on-sync-failed.email: "expense-{{env}}-{{path.basename}}@example.com"

    spec:
      project: expense-prod         # This is the name of 'AppProject' created previously

      source:
        repoURL: https://github.com/my-org/my-repo.git
        targetRevision: main
        path: "{{path}}/helm"
        helm:
          valueFiles:
            - values.yml

      destination:
        server: https://kubernetes.default.svc
        namespace: "expense-{{env}}"

      syncPolicy:
        automated:
          prune: true          # delete resources not in Git
          selfHeal: true       # revert out-of-band changes
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
          - ServerSideApply=true
          - PruneLast=true
```

## ğŸ”¹ Why this is the ONLY safe approach ğŸ”’   
| Approach                       | Works? | Safe? |
| ------------------------------ | ------ | ----- |
| One project, RBAC by namespace | âŒ      | âŒ     |
| One project, app name tricks   | âš ï¸     | âŒ     |
| One project per environment    | âœ…      | âœ…     |
| One cluster per env            | âœ…      | âœ…     |

## ğŸ”¹ Summary ğŸ§ 
âœ” AppProject can have multiple namespaces   
âŒ RBAC cannot restrict namespace access directly   
âœ” Use separate AppProjects for env isolation   
âœ” RBAC â†’ Project/Application   
âœ” This scales cleanly with ApplicationSet   





