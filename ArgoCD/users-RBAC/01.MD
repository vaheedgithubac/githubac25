# AppProject + Users + RBAC
How the RBAC users you defined are enforced via AppProjects.
## Key Concept (important) ğŸ§   
- `argocd-cm` â†’ Defines users
- `argocd-rbac-cm` â†’ Assigns permissions to users   
- `AppProject` â†’ Restricts what resources and destinations those permissions apply to  
RBAC does not grant access to projects automatically â€” the project must explicitly allow it.   

## ğŸ”¹ Example AppProjects  
Weâ€™ll create three projects:  
`expense-frontend`  
`expense-backend`  
`expense-admin`  

## 1.Frontend AppProject (read-only)
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-frontend
  namespace: argocd
spec:
  description: Expense Frontend Project

  sourceRepos:
    - https://github.com/my-org/expense-frontend.git

  destinations:
    - namespace: expense-frontend
      server: https://kubernetes.default.svc

  clusterResourceWhitelist:
    - group: ""
      kind: Namespace

  namespaceResourceWhitelist:
    - group: apps
      kind: Deployment
    - group: ""
      kind: Service
```

## 2. Backend AppProject (read-only)  
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-backend
  namespace: argocd
spec:
  description: Expense Backend Project

  sourceRepos:
    - https://github.com/my-org/expense-backend.git

  destinations:
    - namespace: expense-backend
      server: https://kubernetes.default.svc

  namespaceResourceWhitelist:
    - group: apps
      kind: Deployment
    - group: ""
      kind: Service
```

## 3. Admin AppProject (full access)
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-admin
  namespace: argocd
spec:
  description: Expense Admin Project

  sourceRepos:
    - '*'

  destinations:
    - namespace: '*'
      server: '*'

  clusterResourceWhitelist:
    - group: '*'
      kind: '*'

  namespaceResourceWhitelist:
    - group: '*'
      kind: '*'
```

## ğŸ”¹ Create users in `argocd-cm` ConfigMap  
âœ… `argocd-cm` (define users)   
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  application.namespaces: argocd

  accounts.expense-frontend-user: login
  accounts.expense-backend-user: login
  accounts.expense-admin: login
```

## ğŸ”¹ Tie AppProjects to RBAC users ğŸ”
Now update `argocd-rbac-cm` to bind users to specific projects:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly

  policy.csv: |
    # Frontend user
    p, role:expense-frontend, applications, get, expense-frontend/*, allow
    p, role:expense-frontend, applications, list, expense-frontend/*, allow

    # Backend user
    p, role:expense-backend, applications, get, expense-backend/*, allow
    p, role:expense-backend, applications, list, expense-backend/*, allow

    # Admin user
    p, role:expense-admin, *, *, *, allow

    # Group users to roles
    g, expense-frontend-user, role:expense-frontend
    g, expense-backend-user, role:expense-backend
    g, expense-admin, role:expense-admin
```
ğŸ‘‰ Critical detail:  
expense-frontend/* refers to:  
```php
<project-name>/<application-name>
```  
## ğŸ”¹ What happens if you donâ€™t define the user in argocd-cm?  

| Scenario                   | Result         |
| -------------------------- | -------------  |    
| User not in `argocd-cm`    | âŒ Login fails |
| User in RBAC only          | âŒ Ignored     |
| User in `argocd-cm` + RBAC | âœ… Works       |


## ğŸ”¹ Example Application using the Project  
Frontend app example:  
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: expense-ui
  namespace: argocd
spec:
  project: expense-frontend

  source:
    repoURL: https://github.com/my-org/expense-frontend.git
    path: manifests
    targetRevision: main

  destination:
    server: https://kubernetes.default.svc
    namespace: expense-frontend
```

## ğŸ”¹ Common Mistakes to Avoid âš ï¸
âŒ Forgetting project name in RBAC rule  
âŒ Assuming AppProject grants user permissions (it does NOT)  
âŒ Missing destinations in AppProject â†’ apps wonâ€™t sync  
âŒ Using */* unintentionally (over-permission)  

## ğŸ”¹ Best Practice Recommendation â­  
- Use AppProjects for isolation  
- Use RBAC for authorization  
- Never give */* except to admins  
- Prefer SSO groups â†’ roles in production  
