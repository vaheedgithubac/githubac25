# AppProject + Users + RBAC
How the RBAC users you defined are enforced via AppProjects.
## Key Concept (important) üß†  
- `argocd-cm` ‚Üí Defines users
- `argocd-rbac-cm` ‚Üí Assigns permissions to users   
- `AppProject` ‚Üí Restricts what resources and destinations those permissions apply to  
RBAC does not grant access to projects automatically ‚Äî the project must explicitly allow it.   

## üîπ Example AppProjects  
We‚Äôll create three projects:  
`expense-frontend`  
`expense-backend`  
`expense-admin`  

## 1.Frontend AppProject (read-only)
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-frontend
  namespace: argocd
spec:
  description: Expense Frontend Project

  sourceRepos:
    - https://github.com/my-org/expense-frontend.git

  destinations:
    - namespace: expense-frontend
      server: https://kubernetes.default.svc

  clusterResourceWhitelist:
    - group: ""
      kind: Namespace

  namespaceResourceWhitelist:
    - group: apps
      kind: Deployment
    - group: ""
      kind: Service
```

## 2. Backend AppProject (read-only)  
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-backend
  namespace: argocd
spec:
  description: Expense Backend Project

  sourceRepos:
    - https://github.com/my-org/expense-backend.git

  destinations:
    - namespace: expense-backend
      server: https://kubernetes.default.svc

  namespaceResourceWhitelist:
    - group: apps
      kind: Deployment
    - group: ""
      kind: Service
```

## 3. Admin AppProject (full access)
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-admin
  namespace: argocd
spec:
  description: Expense Admin Project

  sourceRepos:
    - '*'

  destinations:
    - namespace: '*'
      server: '*'

  clusterResourceWhitelist:
    - group: '*'
      kind: '*'

  namespaceResourceWhitelist:
    - group: '*'
      kind: '*'
```

## üîπ Tie AppProjects to RBAC users üîê
Now update `argocd-rbac-cm` to bind users to specific projects:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly

  policy.csv: |
    # Frontend user
    p, role:expense-frontend, applications, get, expense-frontend/*, allow
    p, role:expense-frontend, applications, list, expense-frontend/*, allow

    # Backend user
    p, role:expense-backend, applications, get, expense-backend/*, allow
    p, role:expense-backend, applications, list, expense-backend/*, allow

    # Admin user
    p, role:expense-admin, *, *, *, allow

    # Group users to roles
    g, expense-frontend-user, role:expense-frontend
    g, expense-backend-user, role:expense-backend
    g, expense-admin, role:expense-admin
```
üëâ Critical detail:  
expense-frontend/* refers to:  
```php
<project-name>/<application-name>
```  

## üîπ Example Application using the Project  
Frontend app example:  
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: expense-ui
  namespace: argocd
spec:
  project: expense-frontend

  source:
    repoURL: https://github.com/my-org/expense-frontend.git
    path: manifests
    targetRevision: main

  destination:
    server: https://kubernetes.default.svc
    namespace: expense-frontend
```

## üîπ Common Mistakes to Avoid ‚ö†Ô∏è
‚ùå Forgetting project name in RBAC rule  
‚ùå Assuming AppProject grants user permissions (it does NOT)  
‚ùå Missing destinations in AppProject ‚Üí apps won‚Äôt sync  
‚ùå Using */* unintentionally (over-permission)  

## üîπ Best Practice Recommendation ‚≠ê  
- Use AppProjects for isolation  
- Use RBAC for authorization  
- Never give */* except to admins  
- Prefer SSO groups ‚Üí roles in production  
