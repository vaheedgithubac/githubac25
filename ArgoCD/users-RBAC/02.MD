## ApplicationSet + RBAC + local users (argocd-cm)   
I‚Äôll assume:

- Namespace: `argocd`
- Local users (not SSO)
- One team: expense-frontend
- Git repo per app (can be extended)

## üß© Architecture Overview 
```bash
argocd-cm        ‚Üí defines users (authentication)
argocd-rbac-cm   ‚Üí defines permissions (authorization)
AppProject       ‚Üí limits what resources/apps can exist
ApplicationSet   ‚Üí auto-creates Applications
Application      ‚Üí created dynamically by ApplicationSet
```

## STEP 0Ô∏è‚É£ ‚Äì Prerequisites (DO NOT SKIP) 
**Verify ApplicationSet controller exists**  
```bash
kubectl get deploy -n argocd argocd-applicationset-controller
```
If not present, install ApplicationSet controller

## STEP 1Ô∏è‚É£ ‚Äì Define Users (argocd-cm) üîê

This creates **local Argo CD users**.
```bash
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  application.namespaces: argocd

  accounts.expense-frontend-user: login
  accounts.expense-admin: login
```
Apply:
```bash
kubectl apply -f argocd-cm.yaml
```
Set passwords
```bash
argocd account update-password --account expense-frontend-user
argocd account update-password --account expense-admin
```

## STEP 2Ô∏è‚É£ ‚Äì Create AppProject üß±

**This restricts where ApplicationSet can deploy apps.**
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: expense-frontend
  namespace: argocd
spec:
  description: Expense Frontend Apps

  sourceRepos:
    - https://github.com/my-org/expense-frontend-*

  destinations:
    - server: https://kubernetes.default.svc
      namespace: expense-frontend

  namespaceResourceWhitelist:
    - group: apps
      kind: Deployment
    - group: ""
      kind: Service

  clusterResourceWhitelist: []
```
Apply:  
```bash
kubectl apply -f appproject.yaml
```
STEP 3Ô∏è‚É£ ‚Äì Create ApplicationSet ‚öôÔ∏è  
**This automatically creates Applications.**

### Example: Git directory generator
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: expense-frontend-appset
  namespace: argocd
spec:
  generators:
    - git:
        repoURL: https://github.com/my-org/expense-frontend-apps.git
        revision: main
        directories:
          - path: apps/*
  template:
    metadata:
      name: '{{path.basename}}'
    spec:
      project: expense-frontend

      source:
        repoURL: https://github.com/my-org/expense-frontend-apps.git
        targetRevision: main
        path: '{{path}}'

      destination:
        server: https://kubernetes.default.svc
        namespace: expense-frontend

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
```
Apply:  
```bash
kubectl apply -f applicationset.yaml
```
üëâ This creates Applications like:
```bash
expense-ui
expense-dashboard
```

## STEP 4Ô∏è‚É£ ‚Äì Define RBAC (argocd-rbac-cm) üõÇ

**This is where users are allowed to see ApplicationSet-generated apps.**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly

  policy.csv: |
    # Frontend user (READ-ONLY)
    p, role:expense-frontend, applications, get, expense-frontend/*, allow
    p, role:expense-frontend, applications, list, expense-frontend/*, allow

    # Admin (FULL)
    p, role:expense-admin, *, *, *, allow

    # Bind users to roles
    g, expense-frontend-user, role:expense-frontend
    g, expense-admin, role:expense-admin
```
Apply: 
```bash
kubectl apply -f argocd-rbac-cm.yaml
```
## STEP 5Ô∏è‚É£ ‚Äì Restart Argo CD (IMPORTANT üîÑ)
RBAC and accounts **require restart.**
```bash
kubectl rollout restart deployment argocd-server -n argocd
kubectl rollout restart deployment argocd-repo-server -n argocd
kubectl rollout restart deployment argocd-applicationset-controller -n argocd
```

## STEP 6Ô∏è‚É£ ‚Äì Verify RBAC with CLI üîç  
Login as frontend user:  
```bash
argocd login <ARGOCD_SERVER> --username expense-frontend-user
```

Test permissions  
```bash
argocd app list
argocd app get expense-ui
argocd app sync expense-ui   # ‚ùå should fail
```
Debug permissions  
```bash
argocd account can-i get applications expense-frontend/expense-ui
argocd account can-i sync applications expense-frontend/expense-ui
```

## STEP 7Ô∏è‚É£ ‚Äì What ApplicationSet Changes (Important)  
ApplicationSet:

- Does NOT bypass **RBAC**
- Does NOT bypass **AppProject**
- Applications created are treated like normal Applications

RBAC rule format:
```php
<project>/<application>
```
So this works:
``bash
expense-frontend/*
```

## STEP 8Ô∏è‚É£ ‚Äì Common Mistakes ‚ùå
| Mistake               | Result               |
| --------------------- | -------------------- |
| Missing AppProject    | ApplicationSet fails |
| Wrong project name    | User sees nothing    |
| User not in argocd-cm | Login fails          |
| No restart            | RBAC not applied     |
| Using `*/*`           | Over-permission      |

## STEP 9Ô∏è‚É£ ‚Äì Production Best Practices ‚≠ê
- Prefer OIDC groups over local users
- One AppProject per team
- ApplicationSet per environment
- RBAC scoped to <project>/*
- Avoid admin role except platform team

## FINAL FLOW (Mental Model) üß†
```text
User ‚Üí argocd-cm ‚Üí Login OK
User ‚Üí argocd-rbac-cm ‚Üí Permissions OK
ApplicationSet ‚Üí AppProject ‚Üí Allowed
RBAC ‚Üí AppProject/App ‚Üí Visible
```
